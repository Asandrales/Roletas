<script>
const racas = [
    { nome: "Pebleu",       chance: 45,  cor: "#a3d322" },
    { nome: "Aldeão",       chance: 35,  cor: "#00ff44" },
    { nome: "Nobre",        chance: 15,  cor: "#00d4ff" },
    { nome: "Realeza",      chance: 5,   cor: "#ff2b2b" },
    { nome: "Zogratis",     chance: 1,   cor: "#7bd3ff" },
    { nome: "Grinberryall", chance: 0.5, cor: "#ffcc00" }
];

const canvas = document.getElementById("wheel");
const ctx = canvas.getContext("2d");
const tickSound = document.getElementById("tick");
const winSound = document.getElementById("win");
const btn = document.getElementById("btnGirar");
const resultadoDiv = document.getElementById("resultado");
const avisoFimDiv = document.getElementById("avisoFim");
const girosRestantesDiv = document.getElementById("girosRestantes");

let setores = [];
let angulo = 0;
let animando = false;
let ultimoIndiceTick = -1;

const maxGiros = 3;

// Aqui usamos o localStorage para persistir giros
let giros = parseInt(localStorage.getItem("giros")) || 0;

function atualizarInterface(){
    girosRestantesDiv.innerHTML = `Giros restantes: <b>${Math.max(0, maxGiros - giros)}</b>`;
    if(giros >= maxGiros){
        btn.disabled = true;
        btn.style.opacity = "0.4";
        btn.style.cursor = "not-allowed";
        avisoFimDiv.textContent = "Você usou todos os giros!";
    } else {
        btn.disabled = false;
        btn.style.opacity = "1";
        btn.style.cursor = "pointer";
        avisoFimDiv.textContent = "";
    }
}

function calcularSetores(){
    const tamanhoMinimo = 5;
    const totalChanceReal = racas.reduce((s, r) => s + r.chance, 0);

    let temp = racas.map(r => {
        let chanceVisual = (r.chance / totalChanceReal) * 100;
        if(chanceVisual < tamanhoMinimo) chanceVisual = tamanhoMinimo;
        return { nome: r.nome, cor: r.cor, chanceVisual };
    });

    const totalVisual = temp.reduce((s, r) => s + r.chanceVisual, 0);

    setores = [];
    let acc = 0;
    temp.forEach(r => {
        const inicio = (acc / totalVisual) * Math.PI * 2;
        acc += r.chanceVisual;
        const fim = (acc / totalVisual) * Math.PI * 2;

        setores.push({ nome: r.nome, cor: r.cor, inicio, fim });
    });
}

function desenhar(){
    const w = canvas.width, h = canvas.height;
    const cx = w/2, cy = h/2, radius = Math.min(w,h)/2 - 10;
    ctx.clearRect(0,0,w,h);

    ctx.save();
    ctx.translate(cx, cy);
    ctx.rotate(angulo);

    setores.forEach(s => {
        ctx.beginPath();
        ctx.fillStyle = s.cor;
        ctx.moveTo(0,0);
        ctx.arc(0,0,radius, s.inicio, s.fim);
        ctx.fill();

        ctx.save();
        ctx.fillStyle = "#fff";
        ctx.rotate((s.inicio + s.fim)/2);
        ctx.textAlign = "center";
        ctx.font = "16px Arial";
        ctx.fillText(s.nome, radius * 0.60, 6);
        ctx.restore();
    });

    ctx.beginPath();
    ctx.fillStyle = "#111";
    ctx.arc(0,0, radius * 0.22, 0, Math.PI*2);
    ctx.fill();

    ctx.restore();
}

function pegarSetorAtual(){
    const anguloPonteiro = 3 * Math.PI / 2;
    let ang = (anguloPonteiro - angulo) % (2*Math.PI);
    if(ang < 0) ang += 2*Math.PI;
    return setores.findIndex(s => ang >= s.inicio && ang < s.fim);
}

function girar(){
    if(animando) return;
    if(giros >= maxGiros){
        avisoFimDiv.textContent = "Você usou todos os giros!";
        return;
    }

    giros++;
    localStorage.setItem("giros", giros);
    atualizarInterface();

    animando = true;
    btn.classList.add("girando");

    let velocidade = 0.4;
    let desaceleracao = 0.002;

    function animar(){
        angulo += velocidade;
        desenhar();

        const indice = pegarSetorAtual();
        if(indice !== ultimoIndiceTick){
            tickSound.currentTime = 0;
            tickSound.play();
            ultimoIndiceTick = indice;
        }

        velocidade -= desaceleracao;
        if(velocidade > 0){
            requestAnimationFrame(animar);
        } else {
            animando = false;
            btn.classList.remove("girando");

            const final = pegarSetorAtual();
            resultadoDiv.textContent = "Resultado: " + setores[final].nome;

            winSound.play();
            atualizarInterface();
        }
    }
    animar();
}

btn.onclick = girar;

calcularSetores();
desenhar();
atualizarInterface();
</script>

